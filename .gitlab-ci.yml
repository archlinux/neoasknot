default:
  image: archlinux

linkcheck:
  stage: .pre
  cache:
    key: $CI_JOB_NAME
    paths:
      - .lycheecache
  before_script:
    - pacman -Syu --noconfirm go-yq lychee
  script:
    - yq eval -N '..|.link?' src/content/**/*.yml | lychee -v --cache -- README.md -
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
      allow_failure: true
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

lint:
  stage: .pre
  cache:
    files:
      - package-lock.json
    paths:
      - .npm
  before_script:
    - pacman -Syu --noconfirm npm yamllint
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run lint
    - yamllint src/content
  artifacts:
    paths:
      - node_modules
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"'
      when: never
    - if: '$CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE == "push"'

.artifacts:
  artifacts:
    paths:
      - public

.build:
  extends: .artifacts
  stage: build
  before_script:
    - pacman -Syu --noconfirm npm
  script:
    - npm run build
  after_script:
    - mv build public

build:
  extends: .build
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"'
      when: never
    - if: '$CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE == "push"'

build:secure:
  extends: .build
  tags:
    - secure
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push"'

pages:
  tags:
    - secure
  extends: .artifacts
  stage: deploy
  variables:
    GIT_STRATEGY: none
  script: 'true'
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push"'
