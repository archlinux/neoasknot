default:
  image: archlinux

external linkcheck:
  image:
    name: lycheeverse/lychee
    entrypoint: [""]
  variables:
    GIT_STRATEGY: none
  script:
    - lychee -v --exclude='^javascript:.*' https://whatcanidofor.archlinux.org
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

internal linkcheck:
  before_script:
    - pacman -Syu --noconfirm lychee-link-checker yq
  script:
    - yq '..|.link?' questions/archlinux.yml
      questions/includes/archlinux/**/*.yml | lychee -v -
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
      allow_failure: true

lint:
  before_script:
    - pacman -Syu --noconfirm eslint stylelint-config-standard yamllint
  script:
    - eslint static/site.js
    - stylelint static/themes/*/css
    - yamllint questions
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"'
      when: never
    - if: '$CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE == "push"'

.artifacts:
  artifacts:
    paths:
      - public

.build:
  extends: .artifacts
  before_script:
    - pacman -Syu --noconfirm python-mako python-yaml
  script:
    - ./compile-translations.sh
    - ./asknot-ng.py templates/index.html questions/archlinux.yml
      l10n/fedora/locale --theme archlinux --build public
  after_script:
    - |
      cat << EOF > public/_redirects
      / /en/ 302
      /index.html /en/index.html 302
      EOF

build:
  extends: .build
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"'
      when: never
    - if: '$CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE == "push"'

build:secure:
  extends: .build
  tags:
    - secure
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push"'

pages:
  tags:
    - secure
  extends: .artifacts
  stage: deploy
  variables:
    GIT_STRATEGY: none
  before_script:
    - pacman -Syu --noconfirm brotli
  script:
    - find public -type f -regex '.*\.\(css\|html\|jpg\|js\|png\|svg\)' -exec
      gzip -k {} +
    - find public -type f -regex '.*\.\(css\|html\|jpg\|js\|png\|svg\)' -exec
      brotli {} +
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == "push"'
